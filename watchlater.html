<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Watch Later - OurShow</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="favicon.ico" />
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="icon" href="favicon.ico" />

  <!-- Header -->
  <header class="bg-gray-800 shadow-md p-4">
    <div class="flex items-center justify-between">
      <h1 class="text-3xl font-bold select-none cursor-pointer" id="site-logo" onclick="location.href='index.html'">
        <span class="bg-white text-black px-2 py-1 rounded">Our</span>
        <h1 class="text-3xl font-bold select-none cursor-pointer" onclick="location.href='index.html'">
      </h1>
      <div class="flex gap-2">
        <a href="index.html" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">‚Üê Back to Home</a>
        <button id="clear-all-btn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded hidden">Clear All</button>
          <a href="index.html" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">‚Üê Home</a>
    </div>
  </header>

  <main class="p-4 max-w-6xl mx-auto">
    <h1 class="text-4xl font-bold mb-6">‚è∞ Watch Later</h1>
    
    <div id="watchlater-container" class="space-y-4 min-h-96">
    </div>
        <p class="text-gray-400 text-center py-8">Loading...</p>

  <!-- Modal -->
  <div id="item-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 overflow-y-auto">
    <!-- Content filled by JavaScript -->
    <div id="item-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 overflow-y-auto"></div>
      <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="firebase-config.js"></script>
    <script src="config.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    function loadWatchLater() {
        const clearBtn = document.getElementById('clear-all-btn');

        if (!user) {
          container.innerHTML = '<p class="text-center text-gray-400">Please <a href="login.html" class="text-red-500 underline">log in</a> first</p>';
          return;
        }

        try {
          const ref = firebase.database().ref(`ourshow/users/${user.uid}/watchlater`);
          const snapshot = await ref.get();
          const items = snapshot.exists() ? Object.entries(snapshot.val()).map(([k, v]) => ({ ...v, key: k })) : [];

          if (!items.length) {
            container.innerHTML = '<p class="text-center text-gray-400 py-8">Your watch later list is empty. <a href="index.html" class="text-red-500 underline">Browse and add items</a></p>';
            clearBtn.classList.add('hidden');
            return;
          }

          clearBtn.classList.remove('hidden');

          container.innerHTML = items.map((item, idx) => `
            <div class="bg-gray-800 rounded-lg p-4 flex gap-4 hover:bg-gray-750 transition">
              <img src="${item.posterUrl || 'https://via.placeholder.com/100x150'}" alt="${esc(item.title)}" class="w-24 h-32 object-cover rounded cursor-pointer hover:opacity-80" onclick="openItemModal('${item.id}')">
              <div class="flex-1">
                <h3 class="text-xl font-semibold mb-1 cursor-pointer hover:text-red-500" onclick="openItemModal('${item.id}')">${esc(item.title)}</h3>
                <p class="text-gray-400 mb-2">üìÖ ${esc(item.year || 'N/A')}</p>
                <p class="text-sm text-gray-400 mb-3 line-clamp-2">${esc(item.overview || 'No description')}</p>
                <div class="text-xs text-gray-500 mb-3 space-y-1">
                  ${item.rating ? `<p>‚≠ê ${item.rating.toFixed(1)}</p>` : ''}
                  ${item.popularity ? `<p>üìä ${item.popularity.toFixed(0)}</p>` : ''}
                </div>
                <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" onclick="removeItem('${item.key}')">Remove</button>
              </div>
            </div>
          `).join('');

          window.openItemModal = (id) => {
            const item = items.find(i => i.id == id);
            if (!item) return;
            const modal = document.getElementById('item-modal');
            modal.innerHTML = `
              <div class="bg-gray-900 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto relative p-4 text-white">
                <button onclick="document.getElementById('item-modal').style.display='none'" class="absolute top-4 right-4 bg-red-600 text-white p-2 rounded">‚úï</button>
                <div class="flex gap-6">
                  <img src="${item.posterUrl || 'https://via.placeholder.com/150x225'}" alt="${esc(item.title)}" class="w-32 h-48 object-cover rounded">
                  <div class="flex-1">
                    <h2 class="text-2xl font-bold mb-2">${esc(item.title)}</h2>
                    <p class="text-gray-300 mb-4">üìÖ ${esc(item.year || 'N/A')}</p>
                    <p class="text-gray-400 mb-4">${esc(item.overview || 'No description')}</p>
                    <div class="text-sm text-gray-300 space-y-2">
                      ${item.rating ? `<p>‚≠ê Rating: ${item.rating.toFixed(1)}</p>` : ''}
                      ${item.popularity ? `<p>üìä Popularity: ${item.popularity.toFixed(0)}</p>` : ''}
                    </div>
                  </div>
                </div>
              </div>
            `;
            modal.style.display = 'flex';
          };

          window.removeItem = async (key) => {
            if (!confirm('Remove from watch later?')) return;
            await firebase.database().ref(`ourshow/users/${user.uid}/watchlater/${key}`).remove();
            location.reload();
          };

        } catch (error) {
          console.error('Error:', error);
          container.innerHTML = '<p class="text-center text-red-400 py-8">Error loading watch later list</p>';
        }
      });

      document.getElementById('clear-all-btn').addEventListener('click', async () => {
        if (!confirm('Clear entire watch later list?')) return;
        const user = firebase.auth().currentUser;
        if (user) {
          await firebase.database().ref(`ourshow/users/${user.uid}/watchlater`).remove();
          location.reload();
        }
      });
  </script>
</body>
</html>
