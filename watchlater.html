<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Watch Later - OurShow</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="favicon.ico" />
  <script src="firebase-config.js"></script>
  <script src="config.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">

  <!-- Header -->
  <header class="bg-gray-800 shadow-md p-4">
    <div class="flex items-center justify-between">
      <h1 class="text-3xl font-bold select-none cursor-pointer" onclick="location.href='index.html'">
        <span class="bg-white text-black px-2 py-1 rounded">Our</span><span class="text-red-500">Show</span>
      </h1>
      <div class="flex gap-2">
        <a href="index.html" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">‚Üê Back to Home</a>
        <button id="clear-all-btn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded hidden">Clear All</button>
      </div>
    </div>
  </header>

  <main class="p-4 max-w-6xl mx-auto">
    <h1 class="text-4xl font-bold mb-6">‚è∞ Watch Later</h1>
    <div id="watchlater-container" class="space-y-4 min-h-96">
      <p class="text-gray-400 text-center py-8">Loading...</p>
    </div>
  </main>

  <!-- Modal -->
  <div id="item-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 overflow-y-auto"></div>

  <script type="module">
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
    import { getDatabase, ref, get, remove } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js';

    const auth = window.authMod || getAuth();
    const db = window.dbMod;
    const container = document.getElementById('watchlater-container');
    const clearBtn = document.getElementById('clear-all-btn');
    const itemModal = document.getElementById('item-modal');

    function esc(str) {
      return String(str || '').replace(/[&<>"']/g, (m) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[m]));
    }

    async function loadWatchLater(user) {
      if (!user) {
        container.innerHTML = '<p class="text-center text-gray-400">Please <a href="login.html" class="text-red-500 underline">log in</a> first</p>';
        return;
      }

      try {
        if (!db) {
          container.innerHTML = '<p class="text-center text-gray-400">Firebase not available. Using local storage...</p>';
          const local = JSON.parse(localStorage.getItem('ourshow_watchlater') || '{}');
          displayWatchLater(Object.entries(local).map(([k, v]) => ({ ...v, key: k })));
          return;
        }

        const snapshot = await get(ref(db, `ourshow/users/${user.uid}/watchlater`));
        const items = snapshot.exists() ? Object.entries(snapshot.val()).map(([k, v]) => ({ ...v, key: k })) : [];
        displayWatchLater(items);
      } catch (error) {
        console.error('Error loading watch later:', error);
        container.innerHTML = '<p class="text-center text-red-400 py-8">Error loading watch later list</p>';
      }
    }

    function displayWatchLater(items) {
      if (!items.length) {
        container.innerHTML = '<p class="text-center text-gray-400 py-8">Your watch later list is empty. <a href="index.html" class="text-red-500 underline">Browse and add items</a></p>';
        clearBtn.classList.add('hidden');
        return;
      }

      clearBtn.classList.remove('hidden');

      container.innerHTML = items.map((item, idx) => `
        <div class="bg-gray-800 rounded-lg p-4 flex gap-4 hover:bg-gray-750 transition">
          <img src="${item.posterUrl || 'https://via.placeholder.com/100x150'}" alt="${esc(item.title)}" class="w-24 h-32 object-cover rounded cursor-pointer hover:opacity-80" onclick="openItemModal(${idx})">
          <div class="flex-1">
            <h3 class="text-xl font-semibold mb-1 cursor-pointer hover:text-red-500" onclick="openItemModal(${idx})">${esc(item.title)}</h3>
            <p class="text-gray-400 mb-2">üìÖ ${esc(item.year || 'N/A')}</p>
            <p class="text-sm text-gray-400 mb-3 line-clamp-2">${esc(item.overview || 'No description')}</p>
            <div class="text-xs text-gray-500 mb-3 space-y-1">
              ${item.rating ? `<p>‚≠ê ${item.rating.toFixed(1)}</p>` : ''}
              ${item.popularity ? `<p>üìä ${item.popularity.toFixed(0)}</p>` : ''}
            </div>
            <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" onclick="removeItem('${item.key}')">Remove</button>
          </div>
        </div>
      `).join('');

      window.openItemModal = (idx) => {
        const item = items[idx];
        if (!item) return;
        itemModal.innerHTML = `
          <div class="bg-gray-900 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto relative p-4 text-white">
            <button onclick="document.getElementById('item-modal').classList.add('hidden')" class="absolute top-4 right-4 bg-red-600 text-white p-2 rounded">‚úï</button>
            <div class="flex gap-6">
              <img src="${item.posterUrl || 'https://via.placeholder.com/150x225'}" alt="${esc(item.title)}" class="w-32 h-48 object-cover rounded">
              <div class="flex-1">
                <h2 class="text-2xl font-bold mb-2">${esc(item.title)}</h2>
                <p class="text-gray-300 mb-4">üìÖ ${esc(item.year || 'N/A')}</p>
                <p class="text-gray-400 mb-4">${esc(item.overview || 'No description')}</p>
                <div class="text-sm text-gray-300 space-y-2">
                  ${item.rating ? `<p>‚≠ê Rating: ${item.rating.toFixed(1)}</p>` : ''}
                  ${item.popularity ? `<p>üìä Popularity: ${item.popularity.toFixed(0)}</p>` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
        itemModal.classList.remove('hidden');
      };

      window.removeItem = async (key) => {
        if (!confirm('Remove from watch later?')) return;
        const user = auth.currentUser;
        if (db && user) {
          await remove(ref(db, `ourshow/users/${user.uid}/watchlater/${key}`));
          location.reload();
        } else {
          const local = JSON.parse(localStorage.getItem('ourshow_watchlater') || '{}');
          delete local[key];
          localStorage.setItem('ourshow_watchlater', JSON.stringify(local));
          location.reload();
        }
      };
    }

    onAuthStateChanged(auth, (user) => {
      loadWatchLater(user);
    });

    clearBtn.addEventListener('click', async () => {
      if (!confirm('Clear entire watch later list?')) return;
      const user = auth.currentUser;
      if (db && user) {
        await remove(ref(db, `ourshow/users/${user.uid}/watchlater`));
        location.reload();
      } else {
        localStorage.removeItem('ourshow_watchlater');
        location.reload();
      }
    });

    itemModal.addEventListener('click', (e) => {
      if (e.target === itemModal) {
        itemModal.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
