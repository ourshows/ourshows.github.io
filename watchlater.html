<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Favicon using emoji -->
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé¨</text></svg>">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Watch Later - OurShow</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="favicon.ico" />
  <script src="firebase-config.js"></script>
  <script src="config.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans">

  <!-- Header -->
  <header class="bg-gray-800 shadow-md p-4">
    <div class="flex items-center justify-between">
      <h1 class="text-3xl font-bold select-none cursor-pointer" onclick="location.href='index.html'">
        <span class="bg-white text-black px-2 py-1 rounded">Our</span><span class="text-red-500">Show</span>
      </h1>
      <div class="flex gap-2">
        <a href="index.html" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">‚Üê Back to Home</a>
        <button id="clear-all-btn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded hidden">Clear All</button>
      </div>
    </div>
  </header>

  <main class="p-4 max-w-6xl mx-auto">
    <h1 class="text-4xl font-bold mb-6">‚è∞ Watch Later</h1>
    
    <!-- Stats Bar -->
    <div class="flex gap-4 mb-6 flex-wrap">
      <div class="bg-yellow-600/20 border border-yellow-500/30 px-4 py-2 rounded-lg">
        <span class="text-sm text-gray-400">Movies: </span>
        <span id="movies-count" class="font-bold text-yellow-500">0</span>
      </div>
      <div class="bg-cyan-600/20 border border-cyan-500/30 px-4 py-2 rounded-lg">
        <span class="text-sm text-gray-400">Series: </span>
        <span id="series-count" class="font-bold text-cyan-500">0</span>
      </div>
      <div class="bg-gray-700/50 border border-gray-600 px-4 py-2 rounded-lg">
        <span class="text-sm text-gray-400">Total: </span>
        <span id="total-count" class="font-bold text-white">0</span>
      </div>
    </div>

    <!-- Movies Section -->
    <div class="mb-8">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <span>üé¨</span>
        <span>Movies</span>
        <span class="text-sm font-normal text-gray-400">(<span id="movies-section-count">0</span>)</span>
      </h2>
      <div id="movies-container" class="space-y-4 min-h-32">
        <p class="text-gray-400 text-center py-4">Loading movies...</p>
      </div>
    </div>

    <!-- Series Section -->
    <div class="mb-8">
      <h2 class="text-2xl font-bold mb-4 flex items-center gap-2">
        <span>üì∫</span>
        <span>TV Series</span>
        <span class="text-sm font-normal text-gray-400">(<span id="series-section-count">0</span>)</span>
      </h2>
      <div id="series-container" class="space-y-4 min-h-32">
        <p class="text-gray-400 text-center py-4">Loading series...</p>
      </div>
    </div>

    <!-- Fallback container -->
    <div id="watchlater-container" class="hidden space-y-4 min-h-96">
      <p class="text-gray-400 text-center py-8">Loading...</p>
    </div>
  </main>

  <!-- Modal -->
  <div id="item-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 overflow-y-auto"></div>

  <script type="module">
    import { waitForFirebase } from './firebase-config.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
    import { getDatabase, ref, get, remove } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js';

    const container = document.getElementById('watchlater-container');
    const clearBtn = document.getElementById('clear-all-btn');
    const itemModal = document.getElementById('item-modal');

    function esc(str) {
      return String(str || '').replace(/[&<>"']/g, (m) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[m]));
    }

    (async () => {
      try {
        await waitForFirebase();
      } catch (err) {
        console.warn('Firebase not fully ready yet:', err);
      }

      const auth = window.authMod || getAuth();
      const db = window.dbMod || getDatabase();

      async function loadWatchLater(user) {
        if (!user) {
          container.innerHTML = '<p class="text-center text-gray-400">Please <a href="login.html" class="text-red-500 underline">log in</a> first</p>';
          clearBtn.classList.add('hidden');
          return;
        }

        try {
          if (!db) {
            const local = JSON.parse(localStorage.getItem('ourshow_watchlater') || '{}');
            displayWatchLater(Object.entries(local).map(([k, v]) => ({ ...v, key: k })));
            return;
          }

          const snapshot = await get(ref(db, `ourshow/users/${user.uid}/watchlater`));
          const items = snapshot.exists() ? Object.entries(snapshot.val()).map(([k, v]) => ({ ...v, key: k })) : [];
          displayWatchLater(items);

          // keep local storage in sync
          localStorage.setItem('ourshow_watchlater', JSON.stringify(snapshot.val() || {}));
        } catch (error) {
          console.error('Error loading watch later:', error);
          container.innerHTML = '<p class="text-center text-red-400 py-8">Error loading watch later list</p>';
        }
      }

      function displayWatchLater(items) {
        if (!items.length) {
          const moviesContainer = document.getElementById('movies-container');
          const seriesContainer = document.getElementById('series-container');
          if (moviesContainer) moviesContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No movies in your watch later list yet.</p>';
          if (seriesContainer) seriesContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No series in your watch later list yet.</p>';
          if (container) container.innerHTML = '<p class="text-center text-gray-400 py-8">Your watch later list is empty. <a href="index.html" class="text-red-500 underline">Browse and add items</a></p>';
          clearBtn.classList.add('hidden');
          
          // Update counts to 0
          updateCounts(0, 0, 0);
          return;
        }

        clearBtn.classList.remove('hidden');

        // Separate movies and series
        const movies = [];
        const series = [];

        items.forEach((item, idx) => {
          const type = item.type || item.media_type || '';
          if (type === 'tv' || type === 'series') {
            series.push({ ...item, displayIndex: idx });
          } else {
            movies.push({ ...item, displayIndex: idx });
          }
        });

        // Update counts
        updateCounts(movies.length, series.length, items.length);

        // Store items globally for modal access
        watchLaterItems = items;

        // Display movies
        const moviesContainer = document.getElementById('movies-container');
        if (moviesContainer) {
          if (movies.length === 0) {
            moviesContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No movies in your watch later list yet.</p>';
          } else {
            moviesContainer.innerHTML = movies.map((item) => renderWatchLaterCard(item, items)).join('');
          }
        }

        // Display series
        const seriesContainer = document.getElementById('series-container');
        if (seriesContainer) {
          if (series.length === 0) {
            seriesContainer.innerHTML = '<p class="text-gray-400 text-center py-4">No series in your watch later list yet.</p>';
          } else {
            seriesContainer.innerHTML = series.map((item) => renderWatchLaterCard(item, items)).join('');
          }
        }
      }

      function updateCounts(moviesCount, seriesCount, totalCount) {
        const moviesCountEl = document.getElementById('movies-count');
        const seriesCountEl = document.getElementById('series-count');
        const totalCountEl = document.getElementById('total-count');
        const moviesSectionCountEl = document.getElementById('movies-section-count');
        const seriesSectionCountEl = document.getElementById('series-section-count');

        if (moviesCountEl) moviesCountEl.textContent = moviesCount;
        if (seriesCountEl) seriesCountEl.textContent = seriesCount;
        if (totalCountEl) totalCountEl.textContent = totalCount;
        if (moviesSectionCountEl) moviesSectionCountEl.textContent = moviesCount;
        if (seriesSectionCountEl) seriesSectionCountEl.textContent = seriesCount;
      }

      function renderWatchLaterCard(item, allItems) {
        const idx = item.displayIndex !== undefined ? item.displayIndex : allItems.findIndex(i => i.key === item.key);
        return `
          <div class="bg-gray-800 rounded-lg p-4 flex gap-4 hover:bg-gray-750 transition">
            <img src="${item.posterUrl || 'https://via.placeholder.com/100x150'}" alt="${esc(item.title)}" class="w-24 h-32 object-cover rounded cursor-pointer hover:opacity-80" onclick="openItemModal(${idx})">
            <div class="flex-1">
              <h3 class="text-xl font-semibold mb-1 cursor-pointer hover:text-red-500" onclick="openItemModal(${idx})">${esc(item.title)}</h3>
              <p class="text-gray-400 mb-2">üìÖ ${esc(item.year || 'N/A')}</p>
              <p class="text-sm text-gray-400 mb-3 line-clamp-2">${esc(item.overview || 'No description')}</p>
              <div class="text-xs text-gray-500 mb-3 space-y-1">
                ${item.rating ? `<p>‚≠ê ${item.rating.toFixed(1)}</p>` : ''}
                ${item.popularity ? `<p>üìä ${Math.round(item.popularity)}</p>` : ''}
                ${item.type ? `<p>üé¨ Type: ${esc(item.type === 'tv' ? 'TV Show' : 'Movie')}</p>` : ''}
              </div>
              <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm" onclick="removeItem('${item.key}')">Remove</button>
            </div>
          </div>
        `;
      }

        let watchLaterItems = [];
        window.openItemModal = (idx) => {
          const item = watchLaterItems[idx] || items[idx];
          if (!item) return;
          itemModal.innerHTML = `
            <div class="bg-gray-900 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto relative p-4 text-white">
              <button onclick="document.getElementById('item-modal').classList.add('hidden')" class="absolute top-4 right-4 bg-red-600 text-white p-2 rounded">‚úï</button>
              <div class="flex gap-6">
                <img src="${item.posterUrl || 'https://via.placeholder.com/150x225'}" alt="${esc(item.title)}" class="w-32 h-48 object-cover rounded">
                <div class="flex-1">
                  <h2 class="text-2xl font-bold mb-2">${esc(item.title)}</h2>
                  <p class="text-gray-300 mb-4">üìÖ ${esc(item.year || 'N/A')}</p>
                  <p class="text-gray-400 mb-4">${esc(item.overview || 'No description')}</p>
                  <div class="text-sm text-gray-300 space-y-2">
                    ${item.rating ? `<p>‚≠ê Rating: ${item.rating.toFixed(1)}</p>` : ''}
                    ${item.popularity ? `<p>üìä Popularity: ${Math.round(item.popularity)}</p>` : ''}
                    ${item.type ? `<p>üé¨ Type: ${esc(item.type === 'tv' ? 'TV Show' : 'Movie')}</p>` : ''}
                  </div>
                </div>
              </div>
            </div>
          `;
          itemModal.classList.remove('hidden');
        };

        window.removeItem = async (key) => {
          if (!confirm('Remove from watch later?')) return;
          const user = auth.currentUser;
          if (db && user) {
            await remove(ref(db, `ourshow/users/${user.uid}/watchlater/${key}`));
            loadWatchLater(user);
          } else {
            const local = JSON.parse(localStorage.getItem('ourshow_watchlater') || '{}');
            delete local[key];
            localStorage.setItem('ourshow_watchlater', JSON.stringify(local));
            const items = Object.entries(local).map(([k, v]) => ({ ...v, key: k }));
            displayWatchLater(items);
          }
        };
      }

      onAuthStateChanged(auth, (user) => {
        loadWatchLater(user);
      });

      clearBtn.addEventListener('click', async () => {
        if (!confirm('Clear entire watch later list?')) return;
        const user = auth.currentUser;
        if (db && user) {
          await remove(ref(db, `ourshow/users/${user.uid}/watchlater`));
          loadWatchLater(user);
        } else {
          localStorage.removeItem('ourshow_watchlater');
          displayWatchLater([]);
        }
      });

      itemModal.addEventListener('click', (e) => {
        if (e.target === itemModal) {
          itemModal.classList.add('hidden');
        }
      });
    })();
  </script>
</body>
</html>
