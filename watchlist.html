<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Watchlist - OurShow</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="favicon.ico" />
  <script src="firebase-config.js"></script>
  <script src="config.js"></script>
  <!-- Header -->
  <header class="bg-gray-800 shadow-md p-4">
    <div class="flex items-center justify-between">
      <h1 class="text-3xl font-bold select-none cursor-pointer" id="site-logo" onclick="location.href='index.html'">
        <span class="bg-white text-black px-2 py-1 rounded">Our</span>
        <span class="text-red-500">Show</span>
      </h1>
      <div class="flex gap-2">
        <a href="index.html" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded">‚Üê Back to Home</a>
        <button id="clear-all-btn" class="bg-orange-600 hover:bg-orange-700 text-white px-4 py-2 rounded hidden">Clear All</button>
      </div>
    </div>
  </header>

  <main class="p-4 max-w-6xl mx-auto">
    <h1 class="text-4xl font-bold mb-6">üé¨ My Watchlist</h1>
    
    <div id="watchlist-container" class="space-y-4 min-h-96">
      <p class="text-gray-400 text-center py-8">Loading your watchlist...</p>
    </div>
  </main>

  <!-- Modal -->
  <div id="item-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 overflow-y-auto">
    <!-- Content filled by JavaScript -->
  </div>

  <script>
    const esc = (s) => String(s || "").replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));

    function loadWatchlist() {
      const container = document.getElementById('watchlist-container');
      const clearBtn = document.getElementById('clear-all-btn');
      
      try {
        const watchlist = JSON.parse(localStorage.getItem('ourshow_watchlist') || '[]');
        
        if (!watchlist.length) {
          container.innerHTML = '<p class="text-center text-gray-400 py-8">Your watchlist is empty. <a href="index.html" class="text-red-500 underline">Browse and add items</a></p>';
          clearBtn.classList.add('hidden');
          return;
        }

        clearBtn.classList.remove('hidden');

        container.innerHTML = watchlist.map((item, idx) => `
          <div class="bg-gray-800 rounded-lg p-4 flex gap-4 hover:bg-gray-750 transition">
            <img src="${item.posterUrl || 'https://via.placeholder.com/100x150'}" 
                 alt="${esc(item.title)}" 
                 class="w-24 h-32 object-cover rounded cursor-pointer hover:opacity-80 transition" 
                 onclick="openItemDetails('${item.id}', '${item.type || 'movie'}')">
            
            <div class="flex-1">
              <h3 class="text-xl font-semibold mb-1 cursor-pointer hover:text-red-500 transition" 
                  onclick="openItemDetails('${item.id}', '${item.type || 'movie'}')">${esc(item.title)}</h3>
              <p class="text-gray-400 mb-2">üìÖ ${esc(item.year || 'N/A')}</p>
              <p class="text-sm text-gray-400 mb-3 line-clamp-2">${esc(item.overview || item.description || 'No description')}</p>
              <div class="text-xs text-gray-500 mb-3 space-y-1">
                ${item.rating ? `<p>‚≠ê TMDB Rating: ${item.rating.toFixed(1)}</p>` : ''}
                ${item.popularity ? `<p>üìä Popularity: ${item.popularity.toFixed(0)}</p>` : ''}
              </div>
              <div class="flex gap-2">
                <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm transition" 
                        onclick="moveToWatchLater('${item.id}', ${idx})">Move to Watch Later</button>
                <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm transition" 
                        onclick="removeFromWatchlist(${idx})">Remove</button>
              </div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading watchlist:', error);
        container.innerHTML = '<p class="text-center text-red-400 py-8">Error loading watchlist. Please refresh.</p>';
      }
    }

    function removeFromWatchlist(index) {
      if (!confirm('Remove from watchlist?')) return;
      const watchlist = JSON.parse(localStorage.getItem('ourshow_watchlist') || '[]');
      watchlist.splice(index, 1);
      localStorage.setItem('ourshow_watchlist', JSON.stringify(watchlist));
      loadWatchlist();
    }

    function moveToWatchLater(itemId, index) {
      const watchlist = JSON.parse(localStorage.getItem('ourshow_watchlist') || '[]');
      const item = watchlist.find(i => i.id == itemId);
      if (item) {
        const watchlater = JSON.parse(localStorage.getItem('ourshow_watchlater') || '[]');
        if (!watchlater.find(i => i.id === item.id)) {
          watchlater.push(item);
          localStorage.setItem('ourshow_watchlater', JSON.stringify(watchlater));
          watchlist.splice(index, 1);
          localStorage.setItem('ourshow_watchlist', JSON.stringify(watchlist));
          alert('‚úÖ Moved to Watch Later!');
          loadWatchlist();
        } else {
          alert('Already in Watch Later list');
        }
      }
    }

    function openItemDetails(id, type) {
      const modal = document.getElementById('item-modal');
      modal.innerHTML = '<div class="bg-gray-900 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto relative p-4 text-white"><p class="text-center">Loading...</p></div>';
      modal.style.display = 'flex';

      const watchlist = JSON.parse(localStorage.getItem('ourshow_watchlist') || '[]');
      const item = watchlist.find(i => i.id == id);
      
      if (item) {
        modal.innerHTML = `
          <div class="bg-gray-900 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto relative p-4 text-white">
            <button onclick="document.getElementById('item-modal').style.display='none'" 
                    class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white p-2 rounded z-50">‚úï</button>
            
            <div class="flex gap-6">
              <img src="${item.posterUrl || 'https://via.placeholder.com/150x225'}" 
                   alt="${esc(item.title)}" 
                   class="w-32 h-48 object-cover rounded flex-shrink-0">
              
              <div class="flex-1">
                <h2 class="text-2xl font-bold text-white mb-2">${esc(item.title)}</h2>
                <p class="text-gray-300 mb-4">üìÖ ${esc(item.year || 'N/A')}</p>
                
                <p class="text-gray-400 mb-4">${esc(item.overview || item.description || 'No description available')}</p>
                
                <div class="text-sm text-gray-300 space-y-2 mb-4">
                  ${item.rating ? `<p><strong>Rating:</strong> ‚≠ê ${item.rating.toFixed(1)}</p>` : ''}
                  ${item.popularity ? `<p><strong>Popularity:</strong> üìä ${item.popularity.toFixed(0)}</p>` : ''}
                </div>
              </div>
            </div>
          </div>
        `;
      }
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.style.display = 'none';
      });
    }

    document.getElementById('clear-all-btn').addEventListener('click', () => {
      if (confirm('Clear entire watchlist? This cannot be undone.')) {
        localStorage.removeItem('ourshow_watchlist');
        loadWatchlist();
        alert('‚úÖ Watchlist cleared');
      }
    });

    // Load watchlist on page load
    window.addEventListener('DOMContentLoaded', loadWatchlist);
  </script>
</body>
</html>
